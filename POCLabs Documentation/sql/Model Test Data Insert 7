/*
UPDATE P1
SET ID_PRSN_MOM = P2.ID_PRSN
--SELECT P1.ID_PEOPLE_DIM, P1.ID_PRSN, P1.ID_PEOPLE_DIM_MOM, P1.ID_PRSN_MOM, P2.ID_PRSN
FROM ca.PEOPLE_DIM P1
INNER JOIN ca.PEOPLE_DIM P2 ON
	P2.ID_PEOPLE_DIM = P1.ID_PEOPLE_DIM_MOM
		AND P2.ID_PRSN != P1.ID_PRSN_MOM

UPDATE P1
SET ID_PRSN_DAD = P2.ID_PRSN
--SELECT P1.ID_PEOPLE_DIM, P1.ID_PRSN, P1.ID_PEOPLE_DIM_DAD, P1.ID_PRSN_DAD, P2.ID_PRSN
FROM ca.PEOPLE_DIM P1
INNER JOIN ca.PEOPLE_DIM P2 ON
	P2.ID_PEOPLE_DIM = P1.ID_PEOPLE_DIM_DAD
		AND P2.ID_PRSN != P1.ID_PRSN_DAD

UPDATE ca.PEOPLE_DIM
SET ID_PRSN_MOM = NULL, ID_PEOPLE_DIM_MOM = NULL
--SELECT ID_PEOPLE_DIM, ID_PRSN, ID_PRSN_MOM, ID_PEOPLE_DIM_MOM FROM ca.PEOPLE_DIM
WHERE ID_PRSN = ID_PRSN_MOM

UPDATE ca.PEOPLE_DIM
SET ID_PRSN_DAD = NULL, ID_PEOPLE_DIM_DAD = NULL
--SELECT ID_PEOPLE_DIM, ID_PRSN, ID_PRSN_DAD, ID_PEOPLE_DIM_DAD FROM ca.PEOPLE_DIM
WHERE ID_PRSN = ID_PRSN_DAD

UPDATE C
SET ID_PRSN_MOM = M.ID_PRSN
--SELECT C.ID_PEOPLE_DIM, C.ID_PRSN, C.ID_PEOPLE_DIM_MOM, C.ID_PRSN_MOM, C.DT_ROW_BEGIN, C.DT_ROW_END, M.ID_PEOPLE_DIM, M.ID_PRSN
FROM ca.PEOPLE_DIM C
INNER JOIN ca.PEOPLE_DIM M ON M.ID_PEOPLE_DIM = C.ID_PEOPLE_DIM_MOM
WHERE C.ID_PRSN_MOM IS NULL AND C.ID_PEOPLE_DIM_MOM IS NOT NULL

UPDATE C
SET ID_PRSN_DAD = D.ID_PRSN
--SELECT C.ID_PEOPLE_DIM, C.ID_PRSN, C.ID_PEOPLE_DIM_DAD, C.ID_PRSN_DAD, C.DT_ROW_BEGIN, C.DT_ROW_END, D.ID_PEOPLE_DIM, D.ID_PRSN
FROM ca.PEOPLE_DIM C
INNER JOIN ca.PEOPLE_DIM D ON D.ID_PEOPLE_DIM = C.ID_PEOPLE_DIM_DAD
WHERE C.ID_PRSN_DAD IS NULL AND C.ID_PEOPLE_DIM_DAD IS NOT NULL

UPDATE P
SET ID_PRSN_MOM = NULL
--SELECT ID_PEOPLE_DIM, ID_PRSN, ID_PRSN_MOM, ID_PEOPLE_DIM_MOM
FROM ca.PEOPLE_DIM P
WHERE NOT EXISTS (
	SELECT ID_PEOPLE_DIM
	FROM ca.PEOPLE_DIM M
	WHERE M.ID_PRSN = P.ID_PRSN_MOM
)
	AND P.ID_PRSN_MOM IS NOT NULL

UPDATE P
SET ID_PRSN_DAD = NULL
--SELECT ID_PEOPLE_DIM, ID_PRSN, ID_PRSN_DAD, ID_PEOPLE_DIM_DAD
FROM ca.PEOPLE_DIM P
WHERE NOT EXISTS (
	SELECT ID_PEOPLE_DIM
	FROM ca.PEOPLE_DIM M
	WHERE M.ID_PRSN = P.ID_PRSN_DAD
)
	AND P.ID_PRSN_DAD IS NOT NULL

SELECT DISTINCT ID_PRSN
FROM ca.PEOPLE_DIM
WHERE ID_PRSN = ID_PRSN_MOM
	OR ID_PRSN = ID_PRSN_DAD
UNION
SELECT DISTINCT P1.ID_PRSN
FROM ca.PEOPLE_DIM P1
INNER JOIN ca.PEOPLE_DIM P2 ON
	P2.ID_PEOPLE_DIM = P1.ID_PEOPLE_DIM_MOM
		AND P2.ID_PRSN != P1.ID_PRSN_MOM
UNION
SELECT DISTINCT P1.ID_PRSN
FROM ca.PEOPLE_DIM P1
INNER JOIN ca.PEOPLE_DIM P2 ON
	P2.ID_PEOPLE_DIM = P1.ID_PEOPLE_DIM_DAD
		AND P2.ID_PRSN != P1.ID_PRSN_DAD

UPDATE P
SET ID_PEOPLE_DIM_MOM = M.ID_PEOPLE_DIM_MOM
FROM ca.PEOPLE_DIM P
INNER JOIN (
	SELECT
		PC.ID_PEOPLE_DIM
		,ISNULL(MIN(PM1.ID_PEOPLE_DIM), PM2.ID_PEOPLE_DIM) [ID_PEOPLE_DIM_MOM]
	FROM ca.PEOPLE_DIM PC
	LEFT JOIN ca.PEOPLE_DIM PM1 ON
		PM1.ID_PRSN = PC.ID_PRSN_MOM
			AND (PM1.DT_ROW_BEGIN BETWEEN PC.DT_ROW_BEGIN AND PC.DT_ROW_END
				OR PM1.DT_ROW_END BETWEEN PC.DT_ROW_BEGIN AND PC.DT_ROW_END
				OR PC.DT_ROW_BEGIN BETWEEN PM1.DT_ROW_BEGIN AND PM1.DT_ROW_END
				OR PC.DT_ROW_END BETWEEN PM1.DT_ROW_BEGIN AND PM1.DT_ROW_END)
	LEFT JOIN (
		SELECT
			ID_PRSN
			,MIN(ID_PEOPLE_DIM) [ID_PEOPLE_DIM]
		FROM ca.PEOPLE_DIM
		GROUP BY ID_PRSN
	) PM2 ON
		PM2.ID_PRSN = PC.ID_PRSN_MOM
	WHERE PC.ID_PEOPLE_DIM_MOM IS NULL
		AND PC.ID_PRSN_MOM IS NOT NULL
	GROUP BY
		PC.ID_PEOPLE_DIM
		,PM2.ID_PEOPLE_DIM
) M ON
	M.ID_PEOPLE_DIM = P.ID_PEOPLE_DIM

UPDATE P
SET ID_PEOPLE_DIM_DAD = M.ID_PEOPLE_DIM_DAD
FROM ca.PEOPLE_DIM P
INNER JOIN (
	SELECT
		PC.ID_PEOPLE_DIM
		,ISNULL(MIN(PM1.ID_PEOPLE_DIM), PM2.ID_PEOPLE_DIM) [ID_PEOPLE_DIM_DAD]
	FROM ca.PEOPLE_DIM PC
	LEFT JOIN ca.PEOPLE_DIM PM1 ON
		PM1.ID_PRSN = PC.ID_PRSN_DAD
			AND (PM1.DT_ROW_BEGIN BETWEEN PC.DT_ROW_BEGIN AND PC.DT_ROW_END
				OR PM1.DT_ROW_END BETWEEN PC.DT_ROW_BEGIN AND PC.DT_ROW_END
				OR PC.DT_ROW_BEGIN BETWEEN PM1.DT_ROW_BEGIN AND PM1.DT_ROW_END
				OR PC.DT_ROW_END BETWEEN PM1.DT_ROW_BEGIN AND PM1.DT_ROW_END)
	LEFT JOIN (
		SELECT
			ID_PRSN
			,MIN(ID_PEOPLE_DIM) [ID_PEOPLE_DIM]
		FROM ca.PEOPLE_DIM
		GROUP BY ID_PRSN
	) PM2 ON
		PM2.ID_PRSN = PC.ID_PRSN_DAD
	WHERE PC.ID_PEOPLE_DIM_DAD IS NULL
		AND PC.ID_PRSN_DAD IS NOT NULL
	GROUP BY
		PC.ID_PEOPLE_DIM
		,PM2.ID_PEOPLE_DIM
) M ON
	M.ID_PEOPLE_DIM = P.ID_PEOPLE_DIM
--*/
/*
INSERT dbo.Household
	(HeadPersonKey)
SELECT DISTINCT
	PMP.PersonKey [HeadPersonKey]
FROM ca.PEOPLE_DIM P
INNER JOIN dbo.PersonMapping PMP ON
	PMP.ID_PEOPLE_DIM = ISNULL(P.ID_PEOPLE_DIM_MOM, P.ID_PEOPLE_DIM_DAD)
--*/
/*
INSERT dbo.HouseholdMember
	(EntryDate, Resident, HouseholdKey, PersonKey)
SELECT
	COALESCE(P.EntryDate, C.EntryDate, P.DT_BIRTH, C.DT_BIRTH) [EntryDate]
	,1 [Resident]
	,P.HouseholdKey
	,P.HeadPersonKey [PersonKey]
FROM (
	SELECT 
		H.HouseholdKey
		,H.HeadPersonKey
		,CONVERT(DATETIMEOFFSET(7), CONVERT(VARCHAR, MIN(IIF(P.DT_ROW_BEGIN = '1/1/1901 00:00:01', NULL, P.DT_ROW_BEGIN)), 120) + ' -08:00') [EntryDate]
		,CONVERT(DATETIMEOFFSET(7), CONVERT(VARCHAR, MIN(P.DT_BIRTH), 120) + ' -08:00') [DT_BIRTH]
	FROM dbo.Household H
	INNER JOIN dbo.PersonMapping PM ON
		PM.PersonKey = H.HeadPersonKey
	INNER JOIN ca.PEOPLE_DIM P ON
		P.ID_PRSN = PM.ID_PRSN
	GROUP BY
		H.HouseholdKey
		,H.HeadPersonKey
) P
LEFT JOIN (
	SELECT
		H.HouseholdKey
		,CONVERT(DATETIMEOFFSET(7), CONVERT(VARCHAR, MIN(IIF(C.DT_ROW_BEGIN = '1/1/1901 00:00:01', NULL, C.DT_ROW_BEGIN)), 120) + ' -08:00') [EntryDate]
		,CONVERT(DATETIMEOFFSET(7), CONVERT(VARCHAR, MIN(C.DT_BIRTH), 120) + ' -08:00') [DT_BIRTH]
	FROM dbo.Household H
	INNER JOIN dbo.PersonMapping PM ON
		PM.PersonKey = H.HeadPersonKey
	INNER JOIN ca.PEOPLE_DIM C ON
		ISNULL(C.ID_PEOPLE_DIM_MOM, C.ID_PEOPLE_DIM_DAD) = PM.ID_PEOPLE_DIM
	GROUP BY H.HouseholdKey
) C ON
	C.HouseholdKey = P.HouseholdKey

--SELECT D.ID_PRSN
--FROM ca.PEOPLE_DIM D
--INNER JOIN ca.PEOPLE_DIM C ON
--	C.ID_PEOPLE_DIM_DAD = D.ID_PEOPLE_DIM
--		--AND C.ID_PEOPLE_DIM_MOM IS NOT NULL
----WHERE NOT EXISTS (
----	SELECT P.ID_PEOPLE_DIM
----	FROM ca.PEOPLE_DIM P
----	WHERE P.ID_PEOPLE_DIM_MOM IS NULL
----		AND P.ID_PRSN = C.ID_PRSN
----		AND P.ID_PRSN_DAD = D.ID_PRSN
----)
--GROUP BY D.ID_PRSN
--HAVING SUM(IIF(C.ID_PEOPLE_DIM_MOM IS NULL, 1, 0)) = 0
--EXCEPT

--SELECT D.ID_PRSN
--FROM ca.PEOPLE_DIM D
--INNER JOIN ca.PEOPLE_DIM C ON
--	C.ID_PEOPLE_DIM_DAD = D.ID_PEOPLE_DIM
--		--AND C.ID_PEOPLE_DIM_MOM IS NOT NULL
--INNER JOIN dbo.PersonMapping PMD ON
--	PMD.ID_PEOPLE_DIM = D.ID_PEOPLE_DIM
--WHERE NOT EXISTS (
--	SELECT H.HouseholdKey
--	FROM dbo.Household H
--	WHERE H.HeadPersonKey = PMD.PersonKey
--)
--GROUP BY D.ID_PRSN
--HAVING SUM(IIF(C.ID_PEOPLE_DIM_MOM IS NULL, 1, 0)) = 0

--SELECT
--	COUNT(DISTINCT C.ID_PRSN) [Children with Gender-mis-labeled Parents]
--	,COUNT(DISTINCT IIF(C.ID_PEOPLE_DIM_MOM = C.ID_PEOPLE_DIM_DAD, C.ID_PRSN, NULL)) [Same Person Mom and Dad]
--	,COUNT(DISTINCT IIF(M.CD_GNDR = 'M' AND D.CD_GNDR = 'F', C.ID_PRSN, NULL)) [Gender-switched Mom and Dad]
--	,COUNT(DISTINCT IIF(M.CD_GNDR = 'M', C.ID_PRSN, NULL)) [Male Moms]
--	,COUNT(DISTINCT IIF(M.CD_GNDR = 'M' AND D.CD_GNDR = 'M', C.ID_PRSN, NULL)) [Male Mom and Dad]
--	,COUNT(DISTINCT IIF(M.CD_GNDR = 'M' AND C.ID_PEOPLE_DIM_DAD IS NULL, C.ID_PRSN, NULL)) [Male Mom with no Dad]
--	,COUNT(DISTINCT IIF(D.CD_GNDR = 'F', C.ID_PRSN, NULL)) [Female Dads]
--	,COUNT(DISTINCT IIF(D.CD_GNDR = 'F' AND M.CD_GNDR = 'F', C.ID_PRSN, NULL)) [Female Mom and Dad]
--	,COUNT(DISTINCT IIF(D.CD_GNDR = 'F' AND C.ID_PEOPLE_DIM_MOM IS NULL, C.ID_PRSN, NULL)) [Female Dad with no Mom]
--FROM ca.PEOPLE_DIM C
--LEFT JOIN ca.PEOPLE_DIM M ON
--	M.ID_PEOPLE_DIM = C.ID_PEOPLE_DIM_MOM
--LEFT JOIN ca.PEOPLE_DIM D ON
--	D.ID_PEOPLE_DIM = C.ID_PEOPLE_DIM_DAD
--WHERE C.ID_PRSN_MOM = C.ID_PRSN_DAD
--	OR M.CD_GNDR = 'M'
--	OR D.CD_GNDR = 'F'

--SELECT DISTINCT
--	M.ID_PRSN
--	,M.[Person as Mom Count]
--	,D.[Person as Dad Count]
--	,P.CD_GNDR
--FROM (
--	SELECT 
--		ID_PRSN_MOM [ID_PRSN]
--		,COUNT(ID_PEOPLE_DIM) [Person as Mom Count]
--	FROM ca.PEOPLE_DIM
--	WHERE ID_PEOPLE_DIM_MOM != ID_PEOPLE_DIM_DAD
--		OR (ID_PEOPLE_DIM_MOM IS NOT NULL AND ID_PEOPLE_DIM_DAD IS NULL)
--	GROUP BY ID_PRSN_MOM
--) M
--INNER JOIN (
--	SELECT
--		ID_PRSN_DAD [ID_PRSN]
--		,COUNT(ID_PEOPLE_DIM) [Person as Dad Count]
--	FROM ca.PEOPLE_DIM
--	WHERE ID_PEOPLE_DIM_MOM != ID_PEOPLE_DIM_DAD
--		OR (ID_PEOPLE_DIM_MOM IS NULL AND ID_PEOPLE_DIM_DAD IS NOT NULL)
--	GROUP BY ID_PRSN_DAD
--) D ON
--	D.ID_PRSN = M.ID_PRSN
--INNER JOIN ca.PEOPLE_DIM P ON
--	P.ID_PRSN = M.ID_PRSN
--*/
/*
INSERT dbo.HouseholdMember
	(EntryDate, Resident, HouseholdKey, PersonKey)
SELECT
	COALESCE(C.EntryDate, C.DT_BIRTH, P.Parent_EntryDate, P.Parent_DT_BIRTH) [EntryDate]
	,1 [Resident]
	,C.HouseholdKey
	,C.PersonKey
FROM (
	SELECT
		CONVERT(DATETIMEOFFSET(7), CONVERT(VARCHAR, MIN(IIF(C.DT_ROW_BEGIN = '1/1/1901 00:00:01', NULL, C.DT_ROW_BEGIN)), 120) + ' -08:00') [EntryDate]
		,CONVERT(DATETIMEOFFSET(7), CONVERT(VARCHAR, MIN(C.DT_BIRTH), 120) + ' -08:00') [DT_BIRTH]
		,PM.PersonKey
		,H.HouseholdKey
	FROM ca.PEOPLE_DIM C
	INNER JOIN dbo.PersonMapping PM ON
		PM.ID_PEOPLE_DIM = C.ID_PEOPLE_DIM
	INNER JOIN dbo.PersonMapping PMP ON
		PMP.ID_PEOPLE_DIM = ISNULL(C.ID_PEOPLE_DIM_MOM, C.ID_PEOPLE_DIM_DAD)
	INNER JOIN dbo.Household H ON
		H.HeadPersonKey = PMP.PersonKey
	WHERE ISNULL(C.ID_PRSN_MOM, C.ID_PRSN_DAD) IS NOT NULL
	GROUP BY
		PM.PersonKey
		,H.HouseholdKey
) C
LEFT JOIN (
	SELECT
		CONVERT(DATETIMEOFFSET(7), CONVERT(VARCHAR, MIN(IIF(P.DT_ROW_BEGIN = '1/1/1901 00:00:01', NULL, P.DT_ROW_BEGIN)), 120) + ' -08:00') [Parent_EntryDate]
		,CONVERT(DATETIMEOFFSET(7), CONVERT(VARCHAR, MIN(P.DT_BIRTH), 120) + ' -08:00') [Parent_DT_BIRTH]
		,PM.PersonKey
		,H.HouseholdKey
	FROM ca.PEOPLE_DIM C
	INNER JOIN dbo.PersonMapping PM ON
		PM.ID_PEOPLE_DIM = C.ID_PEOPLE_DIM
	INNER JOIN ca.PEOPLE_DIM P ON
		P.ID_PEOPLE_DIM = ISNULL(C.ID_PEOPLE_DIM_MOM, C.ID_PEOPLE_DIM_DAD)
	INNER JOIN dbo.PersonMapping PMP ON
		PMP.ID_PEOPLE_DIM = ISNULL(C.ID_PEOPLE_DIM_MOM, C.ID_PEOPLE_DIM_DAD)
	INNER JOIN dbo.Household H ON
		H.HeadPersonKey = PMP.PersonKey
	WHERE ISNULL(C.ID_PRSN_MOM, C.ID_PRSN_DAD) IS NOT NULL
	GROUP BY
		PM.PersonKey
		,H.HouseholdKey
	HAVING ISNULL(MIN(IIF(C.DT_ROW_BEGIN = '1/1/1901 00:00:01', NULL, P.DT_ROW_BEGIN)), MIN(C.DT_BIRTH)) IS NULL
) P ON
	P.PersonKey = C.PersonKey
		AND P.HouseholdKey = C.HouseholdKey
--*/
/*
SELECT P1.ID_PEOPLE_DIM, P1.ID_PRSN, P1.ID_PEOPLE_DIM_MOM, P1.ID_PRSN_MOM, P1.ID_PEOPLE_DIM_DAD, P1.ID_PRSN_DAD, P1.DT_ROW_BEGIN, P1.DT_ROW_END
FROM ca.PEOPLE_DIM P1
INNER JOIN (
	SELECT
		ID_PRSN
		,COUNT(DISTINCT ISNULL(ID_PRSN_MOM, ID_PRSN_DAD)) [Distinct Parent]
	FROM ca.PEOPLE_DIM
	WHERE ISNULL(ID_PRSN_MOM, ID_PRSN_DAD) IS NOT NULL
	GROUP BY ID_PRSN
	HAVING COUNT(DISTINCT ISNULL(ID_PRSN_MOM, ID_PRSN_DAD)) != 1
) P2 ON
	P2.ID_PRSN = P1.ID_PRSN
ORDER BY
	ID_PRSN
	,ID_PEOPLE_DIM
--*/
--SELECT COUNT(DISTINCT C.CaseKey), COUNT(DISTINCT PM.HouseholdKey)
--FROM dbo.[Case] C
--INNER JOIN dbo.PersonMapping PM ON 
--	PM.CaseKey = C.CaseKey
--INNER JOIN dbo.HouseholdMember HM ON
--	HM.PersonKey = PM.PersonKey

--SELECT COUNT(*) FROM dbo.[Case]

--SELECT COUNT(*), COUNT(DISTINCT PersonKey), COUNT(DISTINCT HouseholdKey) FROM dbo.HouseholdMember
--SELECT
--	PersonKey
--	,COUNT(HouseholdKey)
--	,COUNT(DISTINCT HouseholdKey)
--	,COUNT(DISTINCT EntryDate)
--FROM dbo.HouseholdMember
--GROUP BY PersonKey
--HAVING COUNT(HouseholdKey) != COUNT(DISTINCT HouseholdKey) 
--	OR (COUNT(DISTINCT HouseholdKey) != 1 AND COUNT(DISTINCT EntryDate) != 1)
--SELECT * FROM HouseholdMember WHERE PersonKey = 4053810 OR HouseholdKey IN (10940, 27749, 31391, 37455) ORDER BY HouseholdKey, PersonKey, EntryDate
--SELECT * FROM HouseholdMember WHERE PersonKey = 1074533

--SELECT COUNT(DISTINCT H.HouseholdKey), COUNT(DISTINCT H.HeadPersonKey), COUNT(HM.HouseholdMemberKey) FROM dbo.Household H LEFT JOIN dbo.HouseholdMember HM ON HM.HouseholdKey = H.HouseholdKey AND HM.PersonKey = H.HeadPersonKey
/*
INSERT dbo.Household
	(HeadPersonKey)
SELECT PM.PersonKey
FROM ca.PAYMENT_FACT PF
INNER JOIN dbo.PersonMapping PM ON
	PM.ID_PEOPLE_DIM = PF.ID_PEOPLE_DIM_CHILD
LEFT JOIN dbo.HouseholdMember HM ON
	HM.PersonKey = PM.PersonKey
GROUP BY PM.PersonKey
HAVING COUNT(DISTINCT HM.HouseholdKey) = 0

INSERT dbo.HouseholdMember
	(EntryDate, Resident, PersonKey, HouseholdKey)
SELECT
	CONVERT(DATETIMEOFFSET(7), CONVERT(VARCHAR, CONVERT(DATETIME, MIN(ISNULL(IIF(P.DT_ROW_BEGIN = '1/1/1901 00:00:01', NULL, CONVERT(DATE, P.DT_ROW_BEGIN)), CONVERT(DATE, CD.CALENDAR_DATE)))), 120) + ' -08:00') [EntryDate]
	,1 [Resident]
	,PM.PersonKey
	,H.HouseholdKey
FROM ca.PAYMENT_FACT PF
INNER JOIN ca.PEOPLE_DIM P ON
	P.ID_PEOPLE_DIM = PF.ID_PEOPLE_DIM_CHILD
INNER JOIN ca.CALENDAR_DIM CD ON
	CD.ID_CALENDAR_DIM = PF.ID_CALENDAR_DIM_WARRANT
INNER JOIN dbo.PersonMapping PM ON
	PM.ID_PEOPLE_DIM = PF.ID_PEOPLE_DIM_CHILD
INNER JOIN dbo.Household H ON
	H.HeadPersonKey = PM.PersonKey
LEFT JOIN dbo.HouseholdMember HM ON
	HM.PersonKey = PM.PersonKey
		AND HM.HouseholdKey = H.HouseholdKey
GROUP BY
	PM.PersonKey
	,H.HouseholdKey
HAVING COUNT(DISTINCT HM.HouseholdKey) = 0
--*/
/*
DECLARE @MaxHouseholdKey INT = (SELECT MAX(HouseholdKey) FROM dbo.Household)
PRINT @MaxHouseholdKey

INSERT dbo.Household
	(HeadPersonKey)
SELECT PM.PersonKey [HeadPersonKey]
FROM ca.PAYMENT_FACT PF
INNER JOIN ca.PEOPLE_DIM P ON
	P.ID_PEOPLE_DIM = PF.ID_PEOPLE_DIM_CHILD
INNER JOIN dbo.PersonMapping PM ON
	PM.ID_PEOPLE_DIM = P.ID_PEOPLE_DIM
		AND P.ID_PEOPLE_DIM_MOM IS NULL
		AND P.ID_PEOPLE_DIM_DAD IS NULL
LEFT JOIN dbo.Household H ON
	H.HeadPersonKey = PM.PersonKey
GROUP BY PM.PersonKey
HAVING COUNT(DISTINCT H.HouseholdKey) != 1

INSERT dbo.HouseholdMember
	(EntryDate, Resident, PersonKey, HouseholdKey)
SELECT
	CONVERT(DATETIMEOFFSET(7), CONVERT(VARCHAR, MIN(IIF(PD.DT_ROW_BEGIN = '1/1/1901 00:00:01', NULL, PD.DT_ROW_BEGIN)), 121) + ' -08:00') [EntryDate]
	,1 [Resident]
	,PM.PersonKey
	,H.HouseholdKey
FROM ca.PAYMENT_FACT PF
INNER JOIN ca.PEOPLE_DIM P ON
	P.ID_PEOPLE_DIM = PF.ID_PEOPLE_DIM_CHILD
INNER JOIN dbo.PersonMapping PM ON
	PM.ID_PEOPLE_DIM = P.ID_PEOPLE_DIM
		AND P.ID_PEOPLE_DIM_MOM IS NULL
		AND P.ID_PEOPLE_DIM_DAD IS NULL
INNER JOIN ca.PEOPLE_DIM PD ON
	PD.ID_PRSN = PF.ID_PRSN_CHILD
INNER JOIN dbo.Household H ON
	H.HeadPersonKey = PM.PersonKey
		AND H.HouseholdKey > @MaxHouseholdKey
GROUP BY
	PM.PersonKey
	,H.HouseholdKey
--*/
/*
UPDATE PK
SET HouseholdKey = H.HouseholdKey
--SELECT
--	PF.ID_PAYMENT_FACT
--	,H.HouseholdKey
FROM ca.PAYMENT_FACT PF
INNER JOIN dbo.PaymentKeys PK ON
	PK.ID_PAYMENT_FACT = PF.ID_PAYMENT_FACT
INNER JOIN ca.PEOPLE_DIM P ON
	P.ID_PEOPLE_DIM = PF.ID_PEOPLE_DIM_CHILD
INNER JOIN dbo.PersonMapping PM ON
	PM.ID_PEOPLE_DIM = COALESCE(P.ID_PEOPLE_DIM_MOM, P.ID_PEOPLE_DIM_DAD, P.ID_PEOPLE_DIM)
INNER JOIN dbo.Household H ON
	H.HeadPersonKey = PM.PersonKey
--*/
/*
UPDATE PM
SET HouseholdKey = H.HouseholdKey
--SELECT
--	P.ID_PEOPLE_DIM
--	,H.HouseholdKey
FROM ca.PEOPLE_DIM P
INNER JOIN dbo.PersonMapping PM ON
	PM.ID_PEOPLE_DIM = P.ID_PEOPLE_DIM
INNER JOIN dbo.PersonMapping PMP ON
	PMP.ID_PEOPLE_DIM = COALESCE(P.ID_PEOPLE_DIM_MOM, P.ID_PEOPLE_DIM_DAD, P.ID_PEOPLE_DIM)
INNER JOIN dbo.Household H ON
	H.HeadPersonKey = PMP.PersonKey
--*/
