-- --------------------------------------------------------------------------------
-- Routine DDL
-- Note: comments before and after the routine body will not be stored by the server
-- --------------------------------------------------------------------------------
DELIMITER $$

CREATE DEFINER=`test_annie`@`localhost` PROCEDURE `sp_PBCS3`(p_date varchar(3000)
,	p_age_grouping_cd varchar(30)
,	p_ethnicity_cd varchar(30)
,	p_office_cd  varchar(500)
, p_bin_ihs_svc_cd varchar(30) 
, p_cd_reporter_type varchar(100) 
, p_filter_access_type varchar(30) 
, p_filter_allegation  varchar(30)
, p_filter_finding varchar(30)
, p_filter_service_category  varchar(100)
, p_filter_service_budget varchar(100)
)
begin
 -- procedure begins here
    declare intfoundpos integer;
    declare strElement varchar(3000);
    declare strValues varchar(3000);
    declare intVal integer;		
    declare intincAll integer;
    declare p_mindate datetime;
    declare p_maxdate datetime;
    declare var_maxmonthstart datetime;
    declare var_minmonthstart datetime;
    declare p_qry_id bigint;
    declare var_county_grp varchar(200);
    declare var_county_grp2 varchar(200);
    declare var_office varchar(500);
    declare var_qry_cnt int;
    declare x1 float;
    declare x2 float;
    declare jitval float;
    declare  flg_procedure_off int;
    declare var_row_cnt_param int;
    declare var_row_cnt_cache int;
    declare var_match_unq_qry_id int;
    declare var_start_year int;
    
    declare ihs0 char(50);
    declare ihs1 char(50);
    declare ihs2 char(50);
    declare ihs3 char(50);

    declare alg0 char(50);
    declare alg1 char(50);
    declare alg2 char(50);
    declare alg3 char(50);
    declare alg4 char(50);

    declare fnd0 char(50);
    declare fnd1 char(50);
    declare fnd2 char(50);
    declare fnd3 char(50);
    declare fnd4 char(50);
    declare eth0  char(100) ;
    declare eth1  char(100) ;
    declare eth2  char(100) ;
    declare eth3  char(100) ;
    declare eth4  char(100) ;
    declare eth5  char(100) ;
    declare eth6  char(100) ;
    declare eth7  char(100) ;
    declare eth8  char(100) ;
    declare eth9  char(100) ;
    declare eth10 char(100) ;
    declare eth11 char(100) ;
    declare eth12 char(100) ;
    
    
    set flg_procedure_off =0;
    
    if  flg_procedure_off =0 then    
            set x1=rand();
            set x2=rand();
            
    --        set jitval= sqrt(-2 * log(x1)) * cos(2*pi()*x2);

    call assign_desc_ihs (ihs0,ihs1,ihs2,ihs3,alg0,alg1,alg2,alg3,alg4,fnd0,fnd1,fnd2,fnd3,fnd4,eth0,eth1,eth2,eth3,eth4,eth5,eth6,eth7,eth8,eth9,eth10,eth11,eth12,7);

        DROP TEMPORARY TABLE IF EXISTS tbltmpValues;
        create temporary table tbltmpValues (strVal varchar(10));


        DROP TEMPORARY TABLE IF EXISTS tbldt;
        create temporary table tbldt(match_date datetime );
        alter table tbldt add primary key(match_date);
 
    
        --  dates
        set strValues=p_date;
        set 	intFoundPos =instr(strValues,','); 
        while intFoundPos <>0 do
                set strElement=SUBSTRING(strValues, 1, intFoundPos-1); 
                SET strValues = RIGHT(strValues,length(strValues)-intFoundPos);
            
                insert into tbltmpValues (strVal) values (strElement);
                set intFoundPos=instr(strValues,',');
        end while;

        if strValues <> ''  then
                INSERT Into tbltmpValues(strVal) values (strValues);
        end if;
        
        insert into tbldt (match_date)
        select distinct cast(strVal as datetime) from tbltmpValues;
     
        --  set dates 
        select min_date_any ,max_date_all 
        into var_minmonthstart,var_maxmonthstart  
        FROM ref_lookup_max_date where id=22;
        select min(match_date),max(match_date) 
        into p_mindate,p_maxdate from tbldt;
        
        set var_start_year= year(var_minmonthstart) ;
        
        -- look for all zeroes to return quickly
        if  (trim(p_bin_ihs_svc_cd)='0' 
   					and trim(p_cd_reporter_type)='0' 
   					and trim(p_filter_access_type)='0' 
   					and trim(p_filter_allegation)='0' 
            and trim(p_filter_finding)='0' 
            and trim(p_filter_service_budget) ='0' 
            and trim(p_filter_service_category)='0'
            and trim(p_age_grouping_cd) ='0' 
            and trim(p_ethnicity_cd)='0'
            and trim(p_office_cd) = '0'  )   then
                
               update cache_pbcs3_params
                set cnt_qry=cnt_qry + 1,last_run_date=now()
                where p_qry_id=1;

              SELECT  
                pbcs3.qry_type as   "qry_type_poc3"
                , pbcs3.date_type
                , pbcs3.start_date  as "Year"
                , pbcs3.cd_sib_age_grp as  "Age_Grouping_Cd"
                , ref_age.tx_sib_age_grp as "Age Grouping"
                , pbcs3.cd_race_census  as "Ethnicity_Cd"
                , ref_eth.tx_race_census as "Race/Ethnicity" 
                , pbcs3.cd_office_collapse as "Office_Cd"
                , ref_ofc.tx_office as Office
                , pbcs3.bin_ihs_svc_cd
                , ref_ihs.bin_ihs_svc_tx as "In-Home Service Desc"
                , pbcs3.cd_reporter_type
                , ref_rpt.tx_reporter_type as "Reporter Desc"
                , pbcs3.cd_access_type
                , ref_acc.tx_access_type as "Access type desc"
                , pbcs3.cd_allegation
                , ref_alg.tx_allegation as "Allegation"
                , pbcs3.cd_finding
                , ref_fnd.tx_finding as "Finding"
                , pbcs3.cd_service_type as "Service Type Cd"
                , ref_srv.tx_subctgry_poc_frc as "Service Type"
                , pbcs3.cd_budget_type as "Budget Cd"
                , ref_bud.tx_budget_poc_frc as "Budget"
                , pbcs3.month as "Month"
                , pbcs3.not_placed as "Not Placed"
                , pbcs3.placed as "Placed"
            FROM cache_pbcs3_aggr pbcs3  
            join ref_lookup_sib_age_grp ref_age on ref_age.cd_sib_age_grp=pbcs3.cd_sib_age_grp
            join ref_lookup_ethnicity_census ref_eth on ref_eth.cd_race_census=pbcs3.cd_race_census
            join ref_lookup_office_collapse ref_ofc on ref_ofc.cd_office=pbcs3.cd_office_collapse
            join ref_filter_ihs_services ref_ihs on ref_ihs.bin_ihs_svc_cd=pbcs3.bin_ihs_svc_cd
            join ref_filter_reporter_type ref_rpt on ref_rpt.cd_reporter_type=pbcs3.cd_reporter_type
            join ref_filter_access_type ref_acc on ref_acc.cd_access_type=pbcs3.cd_access_type
            join ref_filter_allegation ref_alg on ref_alg.cd_allegation=pbcs3.cd_allegation
            join ref_filter_finding ref_fnd on ref_fnd.cd_finding=pbcs3.cd_finding
            join ref_service_cd_subctgry_poc ref_srv on ref_srv.cd_subctgry_poc_frc=pbcs3.cd_service_type
            join ref_service_cd_budget_poc_frc ref_bud on ref_bud.cd_budget_poc_frc=pbcs3.cd_budget_type
            where pbcs3.qry_id=1
            and  pbcs3.int_param_key=power(10,6)  
            and pbcs3.bin_ihs_svc_cd=0
            and pbcs3.cd_reporter_type=0
            and pbcs3.cd_access_type=0
            and pbcs3.cd_allegation=0
            and pbcs3.cd_finding=0
            and pbcs3.cd_service_type=0
            and pbcs3.cd_budget_type=0
            and pbcs3.start_date 
            between p_mindate and p_maxdate
            order by pbcs3.qry_type 
                , pbcs3.date_type
                , pbcs3.start_date  
                , pbcs3.cd_sib_age_grp 
                , pbcs3.cd_race_census 
                , pbcs3.cd_office_collapse 
                  , pbcs3.bin_ihs_svc_cd
                , pbcs3.cd_reporter_type
                , pbcs3.cd_access_type
                , pbcs3.cd_allegation
                , pbcs3.cd_finding
                , pbcs3.cd_service_type 
                , pbcs3.cd_budget_type 
                , pbcs3.month ;     
            
else            
            call load_poc3ab_parameters(
                   p_age_grouping_cd 
                ,  p_ethnicity_cd 
                ,  p_office_cd 
                ,  p_cd_reporter_type 
                ,  p_bin_ihs_svc_cd 
                ,  p_filter_access_type 
                ,  p_filter_allegation  
                ,  p_filter_finding 
                ,  p_filter_service_category  
                ,  p_filter_service_budget
                ,  0
                ,  p_mindate
                ,  p_maxdate);
                
            set p_qry_id=(
            select qry_id 
            from cache_pbcs3_params
            where cd_sib_age_grp=left(p_age_grouping_cd,20)
                and cd_race_census=left(p_ethnicity_cd,30) 
                and cd_office=	left(p_office_cd,250)   
                and cd_reporter_type=left(p_cd_reporter_type,100)
                and bin_ihs_svc_cd=left(p_bin_ihs_svc_cd,30)
                and filter_access_type=left(p_filter_access_type,30)
                and filter_allegation=left(p_filter_allegation,30)
                and filter_finding=left(p_filter_finding,30)
                and filter_srvc_type=left(p_filter_service_category,50)
                and filter_budget=left(p_filter_service_budget,50)
                and min_start_date<=p_mindate
                and max_start_date >=p_maxdate
            order by qry_ID  limit 1);
                
      
            if p_qry_id is null then         
  

                INSERT INTO cache_pbcs3_params
                    (qry_id
                , cd_sib_age_grp
                    , cd_race_census
                , cd_office
                    , bin_ihs_svc_cd
                    , cd_reporter_type
                    , filter_access_type
                    , filter_allegation
                    , filter_finding
                    , filter_srvc_type
                    , filter_budget
                    , min_start_date
                    , max_start_date
                    , cnt_qry
                    , last_run_date)

                    select 
                     (select @qry_ID:=(max(qry_ID) + 1)  from cache_pbcs3_params)
                        ,p_age_grouping_cd
                        ,p_ethnicity_cd
                        ,p_office_cd
                        ,p_bin_ihs_svc_cd
                        ,p_cd_reporter_type
                        ,p_filter_access_type
                        ,p_filter_allegation
                        ,p_filter_finding
                        ,p_filter_service_category
                        ,p_filter_service_budget
                        ,var_minmonthstart
                        ,var_maxmonthstart
                        ,1
                        ,now();
            else
                 update cache_pbcs3_params
                set cnt_qry=cnt_qry + 1,last_run_date=now()
                where qry_id=p_qry_id;
            end if;
            
  
  
  
  drop temporary table if exists cachekeys ;
  create temporary table cachekeys 
  (int_hash_key decimal(22,0)
  ,int_param_key bigint
  ,cd_reporter_type int
  ,bin_ihs_svc_cd int
  ,cd_access_type int
  ,cd_allegation int
  ,cd_finding int
  ,cd_subctgry_poc_frc int
  ,cd_budget_poc_frc int
  ,in_cache int
  ,qry_id int) engine=memory;
  insert into cachekeys
  select	cast((int_param_key * power(10.0,10) ) as decimal(22,0)) + 
                    cast((cd_reporter_type * power(10.0,8) ) as decimal(22,0)) + 
                   cast( (bin_ihs_svc_cd * power(10.0,7) ) as decimal(22,0)) + 
                   cast( (cd_access_type * power(10.0,6)) as decimal(22,0)) + 
                   cast( (cd_allegation * power(10.0,5)) as decimal(22,0)) + 
                   cast( (cd_finding * power(10.0,4)) as decimal(22,0)) + 
                    cast((cd_subctgry_poc_frc * power(10,2)) + cd_budget_poc_frc as decimal(22,0)) as  int_hash_key
                     ,int_param_key
                     ,cd_reporter_type
                     ,bin_ihs_svc_cd
                     ,cd_access_type
                     ,cd_allegation
                     ,cd_finding
                     ,cd_subctgry_poc_frc
                     ,cd_budget_poc_frc
                     ,0 as in_cache
                    ,coalesce(p_qry_id,@qry_ID) as qry_id
				from (select distinct int_param_key from tblprmlocdem) prm
				cross join (select distinct cd_reporter_type from tblrpt) rpt
				cross join (select distinct bin_ihs_svc_cd from tblihs) ihs
				cross join (select distinct cd_access_type from tblacc) acc
				cross join (select distinct cd_allegation from tblalg) alg
				cross join (select distinct cd_finding from tblfnd) fnd
				cross join (select distinct cd_subctgry_poc_frc from tblsrvc) srvc
				cross join (select distinct cd_budget_poc_frc from tblbudg) budg;
   
alter table cachekeys add index idx_int_hash_key(int_hash_key,in_cache);
alter table cachekeys add index idx_qryid_params(qry_id,int_hash_key);
alter table cachekeys 
add index idx_params(int_param_key
,cd_reporter_type,bin_ihs_svc_cd
,cd_access_type,cd_allegation	,cd_finding
,cd_budget_poc_frc
,cd_subctgry_poc_frc
,in_cache);   

update cachekeys,cache_qry_param_pbcs3
        set cachekeys.in_cache=1
            ,cachekeys.qry_id=cache_qry_param_pbcs3.qry_id
        where cachekeys.int_hash_key=cache_qry_param_pbcs3.int_hash_key;    
        
      select sum(in_cache),count(*) ,count(distinct qry_id)
            into var_row_cnt_cache,var_row_cnt_param ,var_match_unq_qry_id
    from cachekeys;
    
                   
if  var_row_cnt_param <> var_row_cnt_cache then 

   drop temporary table if exists s3_total;
   set @incl='
        create temporary table s3_total engine=memory as
    select s3.cohort_begin_date
        ,s3.date_type
        ,s3.qry_type';
        if NOT (p_age_grouping_cd = '0' 
            and p_ethnicity_cd = '0' 
            and p_office_cd = '0' ) then
            set    @incl= concat(@incl,char(13),'
            , mtch.int_param_key ');
        else
            set @incl=concat(@incl,char(13),', 1000000 as int_param_key');
        end if;     
        if trim(p_bin_ihs_svc_cd)='0' then
        set @incl=concat(@incl,char(13),', 0 as bin_ihs_svc_cd');
        else
        set @incl=concat(@incl,char(13),', ihs.bin_ihs_svc_cd');
        end if;
        if trim(p_cd_reporter_type)='0' then
        set @incl=concat(@incl,char(13),', 0 as cd_reporter_type');
        else
        set @incl=concat(@incl,char(13),', rpt.cd_reporter_type');
        end if;	
        if trim(p_filter_access_type)='0' then
        set @incl=concat(@incl,char(13),', 0 as cd_access_type');
        else
        set @incl=concat(@incl,char(13),', acc.cd_access_type');
        end if;					

        if trim(p_filter_allegation)= '0' then
        set @incl=concat(@incl,char(13),', 0 as cd_allegation');
        else
        set @incl=concat(@incl,char(13),', alg.cd_allegation');
        end if;	       
        if trim(p_filter_finding)='0' then
        set @incl=concat(@incl,char(13),', 0 as cd_finding');
        else
        set @incl=concat(@incl,char(13),', fnd.cd_finding');
        end if;	        
        if trim(p_filter_service_category) = '0'  then
        set @incl=concat(@incl,', 0 as cd_subctgry_poc_frc');
        else
        set @incl=concat(@incl,', srv.cd_subctgry_poc_frc');
        end if;	        
        if trim(p_filter_service_budget) ='0' then
        set @incl=concat(@incl,', 0 as cd_budget_poc_frc');
        else
        set @incl=concat(@incl,', bud.cd_budget_poc_frc ');
        end if;
        if NOT (p_age_grouping_cd = '0' 
            and p_ethnicity_cd = '0' 
            and p_office_cd = '0' ) then
         set    @incl= concat(@incl,char(13),'
             , cast(( mtch.int_param_key * power(10.0,10) ) as decimal(22,0))  ');
        else
            set @incl=concat(@incl,char(13),', cast((1000000 * power(10.0,10) ) as decimal(22,0))');
        end if;
       if trim(p_cd_reporter_type)<>'0' then
	        set @incl=concat(@incl,'
            + cast((rpt.cd_reporter_type * power(10.0,8) ) as decimal(22,0)) ');
        end if;					
        if trim(p_bin_ihs_svc_cd)<>'0' then
	        set @incl=concat(@incl,' 
            + cast( (ihs.bin_ihs_svc_cd * power(10.0,7) ) as decimal(22,0))');
        end if;
       if trim(p_filter_access_type)<>'0' then
	        set @incl=concat(@incl,' 
            + cast((acc.cd_access_type * power(10.0,6)) as decimal(22,0))');
        end if;					

        if trim(p_filter_allegation) <> '0' then
	        set @incl=concat(@incl,' 
            + cast( (alg.cd_allegation * power(10.0,5)) as decimal(22,0))');
        end if;	       
        if trim(p_filter_finding) <> '0' then
	        set @incl=concat(@incl,'
            + cast( (fnd.cd_finding * power(10.0,4)) as decimal(22,0))');
        end if;	        
        if trim(p_filter_service_category) <> '0' then
	        set @incl=concat(@incl,'
            + cast((srv.cd_subctgry_poc_frc * power(10,2)) as decimal(22,0))');
        end if;	        
        if trim(p_filter_service_budget) <> '0' then
	        set @incl=concat(@incl,'
            +  bud.cd_budget_poc_frc ');   
        end if;
     set @incl=concat(@incl,'as int_hash_key');
     set @incl=concat(@incl,char(13),'
      ,sum(cnt_case) as total_cases
  FROM prtl_pbcs3 s3');
   if NOT (p_age_grouping_cd = '0' 
            and p_ethnicity_cd = '0' 
            and p_office_cd = '0' ) then
         set    @incl= concat(@incl,char(13),'
  	join tblprmlocdem mtch on mtch.int_match_param_key=s3.int_match_param_key 
		and  mtch.cd_race_census in (select distinct cd_race from tbleth)');
    end if;
        if trim(p_bin_ihs_svc_cd)<>'0' then
	        set @incl=concat(@incl,char(13),'
			join tblihs ihs on ihs.match_code=s3.bin_ihs_svc_cd');
        end if;
        if trim(p_cd_reporter_type)<>'0' then
	        set @incl=concat(@incl,char(13),'
			join tblrpt rpt on rpt.match_code=s3.cd_reporter_type');
        end if;					
        if trim(p_filter_access_type)<>'0' then
	        set @incl=concat(@incl,char(13),'
			join tblacc acc on acc.match_code=s3.filter_access_type');
        end if;					

        if trim(p_filter_allegation) <> '0' then
	        set @incl=concat(@incl,char(13),'
			join tblalg alg on alg.match_code=s3.filter_allegation');
        end if;	       
        if trim(p_filter_finding) <> '0' then
	        set @incl=concat(@incl,char(13),'
			join tblfnd fnd on fnd.match_code=s3.filter_finding');
        end if;	        
        if trim(p_filter_service_category) <> '0' then
	        set @incl=concat(@incl,char(13),'
			join tblsrvc srv on srv.match_code=s3.filter_service_type');
        end if;	        
        if trim(p_filter_service_budget) <> '0' then
	        set @incl=concat(@incl,char(13),'
			join tblbudg bud on bud.match_code=s3.filter_budget_type ');
        end if;	      
set @incl=concat(@incl,char(13),'join cachekeys ck on 
         ck.int_hash_key=');
     if NOT (p_age_grouping_cd = '0' 
            and p_ethnicity_cd = '0' 
            and p_office_cd = '0' ) then
         set    @incl= concat(@incl,char(13),'
             cast(( mtch.int_param_key * power(10.0,10) ) as decimal(22,0))  ');
        else
            set @incl=concat(@incl,char(13),' cast((1000000 * power(10.0,10) ) as decimal(22,0))');
        end if;
       if trim(p_cd_reporter_type)<>'0' then
	        set @incl=concat(@incl,'
            + cast((rpt.cd_reporter_type * power(10.0,8) ) as decimal(22,0)) ');
        end if;					
        if trim(p_bin_ihs_svc_cd)<>'0' then
	        set @incl=concat(@incl,' 
            + cast( (ihs.bin_ihs_svc_cd * power(10.0,7) ) as decimal(22,0))');
        end if;
       if trim(p_filter_access_type)<>'0' then
	        set @incl=concat(@incl,' 
            + cast((acc.cd_access_type * power(10.0,6)) as decimal(22,0))');
        end if;					

        if trim(p_filter_allegation) <> '0' then
	        set @incl=concat(@incl,' 
            + cast( (alg.cd_allegation * power(10.0,5)) as decimal(22,0))');
        end if;	       
        if trim(p_filter_finding) <> '0' then
	        set @incl=concat(@incl,'
            + cast( (fnd.cd_finding * power(10.0,4)) as decimal(22,0))');
        end if;	        
        if trim(p_filter_service_category) <> '0' then
	        set @incl=concat(@incl,'
            + cast((srv.cd_subctgry_poc_frc * power(10,2)) as decimal(22,0))');
        end if;	        
        if trim(p_filter_service_budget) <> '0' then
	        set @incl=concat(@incl,'
            +  bud.cd_budget_poc_frc ');
        end if;	
        set @incl=concat(@incl,char(13),' and ck.in_cache=0');
set @incl=concat(@incl,char(13),'
	group by s3.cohort_begin_date
      ,s3.date_type
      ,s3.qry_type');
        if NOT (p_age_grouping_cd = '0' 
            and p_ethnicity_cd = '0' 
            and p_office_cd = '0' ) then
         set    @incl= concat(@incl,char(13),'
                                    , mtch.int_param_key');
        end if;
        if trim(p_bin_ihs_svc_cd)<>'0' then
	        set @incl=concat(@incl,char(13),'
			, ihs.bin_ihs_svc_cd');
        end if;
        if trim(p_cd_reporter_type)<>'0' then
	        set @incl=concat(@incl,char(13),'
			, rpt.cd_reporter_type');
        end if;					
        if trim(p_filter_access_type)<>'0' then
	        set @incl=concat(@incl,char(13),'
			, acc.cd_access_type');
        end if;					

        if trim(p_filter_allegation) <> '0' then
	        set @incl=concat(@incl,char(13),'
			, alg.cd_allegation');
        end if;	       
        if trim(p_filter_finding) <> '0' then
	        set @incl=concat(@incl,char(13),'
			, fnd.cd_finding');
        end if;	        
        if trim(p_filter_service_category) <> '0' then
	        set @incl=concat(@incl,char(13),'
			, srv.cd_subctgry_poc_frc');
        end if;	        
        if trim(p_filter_service_budget) <> '0' then
	        set @incl=concat(@incl,char(13),'
			, bud.cd_budget_poc_frc ');
        end if;	
         if NOT (p_age_grouping_cd = '0' 
            and p_ethnicity_cd = '0' 
            and p_office_cd = '0' ) then
         set    @incl= concat(@incl,char(13),'
                                    , mtch.cd_sib_age_grp 
                                    , mtch.cd_race_census
                                    , mtch.cd_office');  
         end if;
         set @incl=concat(@incl,';',char(13));   
         

               
        PREPARE stmt FROM @incl;
        EXECUTE stmt;
        DEALLOCATE PREPARE stmt;
          create index idx_params on s3_total (cohort_begin_date,date_type,qry_type,int_param_key);
        create index idx_other_params on s3_total (cohort_begin_date,date_type,qry_type,cd_reporter_type,cd_access_type,cd_allegation,cd_finding);

        set @incl='';
        set @incl='	INSERT INTO cache_pbcs3_aggr
				   (qry_type
				   ,date_type
				   ,start_date
				   ,int_param_key
				   ,bin_ihs_svc_cd
				   ,cd_reporter_type
				   ,cd_access_type
				   ,cd_allegation
				   ,cd_finding
				   ,cd_service_type
				   ,cd_budget_type
				   ,cd_sib_age_grp
				   ,cd_race_census
				   ,cd_office_collapse
				   ,month
				   ,placed
				   ,not_placed
				   ,min_start_date
				   ,max_start_date
				   ,x1
				   ,x2
				   ,insert_date
				   ,qry_id
				   ,start_year
				   ,int_hash_key)
                   
    	SELECT       
          prtl_pbcs3.qry_type
        , prtl_pbcs3.date_type
        , prtl_pbcs3.cohort_begin_date';
                       
      if NOT (p_age_grouping_cd = '0' 
            and p_ethnicity_cd = '0' 
            and p_office_cd = '0' ) then
            set    @incl= concat(@incl,char(13),'
            , mtch.int_param_key ');
        else
            set @incl=concat(@incl,char(13),', 1000000 as int_param_key');
        end if;     
        if trim(p_bin_ihs_svc_cd)='0' then
        set @incl=concat(@incl,char(13),', 0 as bin_ihs_svc_cd');
        else
        set @incl=concat(@incl,char(13),', ihs.bin_ihs_svc_cd');
        end if;
        if trim(p_cd_reporter_type)='0' then
        set @incl=concat(@incl,char(13),', 0 as cd_reporter_type');
        else
        set @incl=concat(@incl,char(13),', rpt.cd_reporter_type');
        end if;	
        if trim(p_filter_access_type)='0' then
        set @incl=concat(@incl,char(13),', 0 as cd_access_type');
        else
        set @incl=concat(@incl,char(13),', acc.cd_access_type');
        end if;					

        if trim(p_filter_allegation)= '0' then
        set @incl=concat(@incl,char(13),', 0 as cd_allegation');
        else
        set @incl=concat(@incl,char(13),', alg.cd_allegation');
        end if;	       
        if trim(p_filter_finding)='0' then
        set @incl=concat(@incl,char(13),', 0 as cd_finding');
        else
        set @incl=concat(@incl,char(13),', fnd.cd_finding');
        end if;	        
        if trim(p_filter_service_category) = '0'  then
        set @incl=concat(@incl,', 0 as cd_subctgry_poc_frc');
        else
        set @incl=concat(@incl,', srv.cd_subctgry_poc_frc');
        end if;	        
        if trim(p_filter_service_budget) ='0' then
        set @incl=concat(@incl,', 0 as cd_budget_poc_frc');
        else
        set @incl=concat(@incl,', bud.cd_budget_poc_frc ');
        end if;
     if NOT (p_age_grouping_cd = '0' 
            and p_ethnicity_cd = '0' 
            and p_office_cd = '0' ) then
            set    @incl= concat(@incl,char(13),'
            	, mtch.cd_sib_age_grp 
            , mtch.cd_race_census
            , mtch.cd_office');
      else
            set    @incl= concat(@incl,char(13),',0,0,0');
      end if;
      
    set @incl=concat(@incl,char(13),', cal.mnth "Month"
    , sum(cnt_case)/(s3_total.total_cases * 1.00) * 100 as "Placed"
	, 100.00 - sum(cnt_case)/(s3_total.total_cases * 1.00) * 100 as "Not Placed"');
  		set @incl=concat(@incl,char(13),', DATE',char(39), var_minmonthstart,char(39));
		set @incl=concat(@incl,char(13),', DATE',char(39), var_maxmonthstart,char(39));
		set @incl=concat(@incl,char(13),', ',char(39), x1,char(39));
		set @incl=concat(@incl,char(13),', ',char(39), x2,char(39));    
		set @incl=concat(@incl,char(13),', DATE',char(39), now() ,char(39),' as insert_date'); 
		set @incl=concat(@incl,char(13),', ',char(39), @qry_id,char(39),char(13),'
                                    ,year(prtl_pbcs3.cohort_begin_date)');
    set @incl=concat(@incl,char(13),', ck.int_hash_key
    from prtl_pbcs3');
    if NOT (p_age_grouping_cd = '0' 
            and p_ethnicity_cd = '0' 
            and p_office_cd = '0' ) then
         set    @incl= concat(@incl,char(13),'
          join tblprmlocdem mtch on mtch.int_match_param_key=prtl_pbcs3.int_match_param_key 
            and mtch.cd_race_census in (select distinct cd_race from tbleth)');
    end if;
      if trim(p_bin_ihs_svc_cd)<>'0' then
	        set @incl=concat(@incl,char(13),'
			join tblihs ihs on ihs.match_code=prtl_pbcs3.bin_ihs_svc_cd');
        end if;
        if trim(p_cd_reporter_type)<>'0' then
	        set @incl=concat(@incl,char(13),'
			join tblrpt rpt on rpt.match_code=prtl_pbcs3.cd_reporter_type');
        end if;					
        if trim(p_filter_access_type)<>'0' then
	        set @incl=concat(@incl,char(13),'
			join tblacc acc on acc.match_code=prtl_pbcs3.filter_access_type');
        end if;					

        if trim(p_filter_allegation) <> '0' then
	        set @incl=concat(@incl,char(13),'
			join tblalg alg on alg.match_code=prtl_pbcs3.filter_allegation');
        end if;	       
        if trim(p_filter_finding) <> '0' then
	        set @incl=concat(@incl,char(13),'
			join tblfnd fnd on fnd.match_code=prtl_pbcs3.filter_finding');
        end if;	        
        if trim(p_filter_service_category) <> '0' then
	        set @incl=concat(@incl,char(13),'
			join tblsrvc srv on srv.match_code=prtl_pbcs3.filter_service_type');
        end if;	        
        if trim(p_filter_service_budget) <> '0' then
	        set @incl=concat(@incl,char(13),'
			join tblbudg bud on bud.match_code=prtl_pbcs3.filter_budget_type ');
        end if;	
       set @incl=concat(@incl,char(13),'join cachekeys ck on 
         ck.int_hash_key=');
     if NOT (p_age_grouping_cd = '0' 
            and p_ethnicity_cd = '0' 
            and p_office_cd = '0' ) then
         set    @incl= concat(@incl,char(13),'
             cast(( mtch.int_param_key * power(10.0,10) ) as decimal(22,0))  ');
        else
            set @incl=concat(@incl,char(13),' cast((1000000 * power(10.0,10) ) as decimal(22,0))');
        end if;
       if trim(p_cd_reporter_type)<>'0' then
	        set @incl=concat(@incl,'
            + cast((rpt.cd_reporter_type * power(10.0,8) ) as decimal(22,0)) ');
        end if;					
        if trim(p_bin_ihs_svc_cd)<>'0' then
	        set @incl=concat(@incl,' 
            + cast( (ihs.bin_ihs_svc_cd * power(10.0,7) ) as decimal(22,0))');
        end if;
       if trim(p_filter_access_type)<>'0' then
	        set @incl=concat(@incl,' 
            + cast((acc.cd_access_type * power(10.0,6)) as decimal(22,0))');
        end if;					

        if trim(p_filter_allegation) <> '0' then
	        set @incl=concat(@incl,' 
            + cast( (alg.cd_allegation * power(10.0,5)) as decimal(22,0))');
        end if;	       
        if trim(p_filter_finding) <> '0' then
	        set @incl=concat(@incl,'
            + cast( (fnd.cd_finding * power(10.0,4)) as decimal(22,0))');
        end if;	        
        if trim(p_filter_service_category) <> '0' then
	        set @incl=concat(@incl,'
            + cast((srv.cd_subctgry_poc_frc * power(10,2)) as decimal(22,0))');
        end if;	        
        if trim(p_filter_service_budget) <> '0' then
	        set @incl=concat(@incl,'
            +  bud.cd_budget_poc_frc ');
        end if;	
        set @incl=concat(@incl,char(13),' and ck.in_cache=0');
        set @incl=concat(@incl,char(13),' join (select number * 3 as mnth from numbers where number between 1 and 16) cal 
        on prtl_pbcs3.min_placed_within_month <=cal.mnth');
       set @incl= concat(@incl,char(13),' join s3_total on 
       S3_total.cohort_begin_date =prtl_pbcs3.cohort_begin_date
	and s3_total.date_type =prtl_pbcs3.date_type
	and s3_total.qry_type =prtl_pbcs3.qry_type
  and s3_total.int_hash_key=');
   if NOT (p_age_grouping_cd = '0' 
            and p_ethnicity_cd = '0' 
            and p_office_cd = '0' ) then
         set    @incl= concat(@incl,char(13),'
             cast(( mtch.int_param_key * power(10.0,10) ) as decimal(22,0))  ');
        else
            set @incl=concat(@incl,char(13),' cast((1000000 * power(10.0,10) ) as decimal(22,0))');
        end if;
       if trim(p_cd_reporter_type)<>'0' then
	        set @incl=concat(@incl,'
            + cast((rpt.cd_reporter_type * power(10.0,8) ) as decimal(22,0)) ');
        end if;					
        if trim(p_bin_ihs_svc_cd)<>'0' then
	        set @incl=concat(@incl,' 
            + cast( (ihs.bin_ihs_svc_cd * power(10.0,7) ) as decimal(22,0))');
        end if;
       if trim(p_filter_access_type)<>'0' then
	        set @incl=concat(@incl,' 
            + cast((acc.cd_access_type * power(10.0,6)) as decimal(22,0))');
        end if;					

        if trim(p_filter_allegation) <> '0' then
	        set @incl=concat(@incl,' 
            + cast( (alg.cd_allegation * power(10.0,5)) as decimal(22,0))');
        end if;	       
        if trim(p_filter_finding) <> '0' then
	        set @incl=concat(@incl,'
            + cast( (fnd.cd_finding * power(10.0,4)) as decimal(22,0))');
        end if;	        
        if trim(p_filter_service_category) <> '0' then
	        set @incl=concat(@incl,'
            + cast((srv.cd_subctgry_poc_frc * power(10,2)) as decimal(22,0))');
        end if;	        
        if trim(p_filter_service_budget) <> '0' then
	        set @incl=concat(@incl,'
            +  bud.cd_budget_poc_frc ');
        end if;	
        set @incl=concat(@incl,char(13),'group by 
        prtl_pbcs3.cohort_begin_date
      ,prtl_pbcs3.date_type
      ,prtl_pbcs3.qry_type
      , cal.mnth');
      if NOT (p_age_grouping_cd = '0' 
            and p_ethnicity_cd = '0' 
            and p_office_cd = '0' ) then
         set    @incl= concat(@incl,char(13),'
       	    , mtch.int_param_key
            , mtch.cd_sib_age_grp 
            , mtch.cd_race_census
            , mtch.cd_office');
    end if;
         if trim(p_bin_ihs_svc_cd)<>'0' then
	        set @incl=concat(@incl,char(13),'
			, ihs.bin_ihs_svc_cd');
        end if;
        if trim(p_cd_reporter_type)<>'0' then
	        set @incl=concat(@incl,char(13),'
			, rpt.cd_reporter_type');
        end if;					
        if trim(p_filter_access_type)<>'0' then
	        set @incl=concat(@incl,char(13),'
			, acc.cd_access_type');
        end if;					

        if trim(p_filter_allegation) <> '0' then
	        set @incl=concat(@incl,char(13),'
			, alg.cd_allegation');
        end if;	       
        if trim(p_filter_finding) <> '0' then
	        set @incl=concat(@incl,char(13),'
			, fnd.cd_finding');
        end if;	        
        if trim(p_filter_service_category) <> '0' then
	        set @incl=concat(@incl,char(13),'
			, srv.cd_subctgry_poc_frc');
        end if;	        
        if trim(p_filter_service_budget) <> '0' then
	        set @incl=concat(@incl,char(13),'
			, bud.cd_budget_poc_frc ');
        end if;
 set @incl=concat(@incl,char(13),', ck.int_hash_key',char(13),', s3_total.total_cases');
 set @incl=concat(@incl,';');

        PREPARE stmt FROM @incl;
        EXECUTE stmt;
        DEALLOCATE PREPARE stmt;
    insert into cache_qry_param_pbcs3
					
					select ck.int_param_key
								   ,bin_ihs_svc_cd
								   ,cd_reporter_type
								   ,cd_access_type
								   ,cd_allegation
								   ,cd_finding
								   ,cd_subctgry_poc_frc
								   ,cd_budget_poc_frc
								   ,q.cd_sib_age_grp
								   ,q.cd_race_census
								   ,q.cd_office
								   ,@qry_id
								   ,int_hash_key
						from cachekeys ck
						join (select distinct int_param_key,cd_sib_age_grp,cd_race_census,cd_office from tblprmlocdem)  q on q.int_param_key=ck.int_param_key
						where ck.in_cache=0;
end if; --  not in cache


           SELECT  
                pbcs3.qry_type as   "qry_type_poc3"
                , pbcs3.date_type
                , pbcs3.start_date  as "Year"
                , pbcs3.cd_sib_age_grp as  "Age_Grouping_Cd"
                , ref_age.tx_sib_age_grp as "Age Grouping"
                , pbcs3.cd_race_census  as "Ethnicity_Cd"
                , ref_eth.tx_race_census as "Race/Ethnicity" 
                , pbcs3.cd_office_collapse as "Office_Cd"
                , ref_ofc.tx_office as Office
                , pbcs3.bin_ihs_svc_cd
                , ref_ihs.bin_ihs_svc_tx as "In-Home Service Desc"
                , pbcs3.cd_reporter_type
                , ref_rpt.tx_reporter_type as "Reporter Desc"
                , pbcs3.cd_access_type
                , ref_acc.tx_access_type as "Access type desc"
                , pbcs3.cd_allegation
                , ref_alg.tx_allegation as "Allegation"
                , pbcs3.cd_finding
                , ref_fnd.tx_finding as "Finding"
                , pbcs3.cd_service_type as "Service Type Cd"
                , ref_srv.tx_subctgry_poc_frc as "Service Type"
                , pbcs3.cd_budget_type as "Budget Cd"
                , ref_bud.tx_budget_poc_frc as "Budget"
                , pbcs3.month as "Month"
                , pbcs3.not_placed as "Not Placed"
                , pbcs3.placed as "Placed"
            FROM cache_pbcs3_aggr pbcs3  
            join cachekeys ck on ck.int_hash_key=pbcs3.int_hash_key
                and pbcs3.qry_id=ck.qry_id
            join ref_lookup_sib_age_grp ref_age on ref_age.cd_sib_age_grp=pbcs3.cd_sib_age_grp
            join ref_lookup_ethnicity_census ref_eth on ref_eth.cd_race_census=pbcs3.cd_race_census
            join ref_lookup_office_collapse ref_ofc on ref_ofc.cd_office=pbcs3.cd_office_collapse
            join ref_filter_ihs_services ref_ihs on ref_ihs.bin_ihs_svc_cd=pbcs3.bin_ihs_svc_cd
            join ref_filter_reporter_type ref_rpt on ref_rpt.cd_reporter_type=pbcs3.cd_reporter_type
            join ref_filter_access_type ref_acc on ref_acc.cd_access_type=pbcs3.cd_access_type
            join ref_filter_allegation ref_alg on ref_alg.cd_allegation=pbcs3.cd_allegation
            join ref_filter_finding ref_fnd on ref_fnd.cd_finding=pbcs3.cd_finding
            join ref_service_cd_subctgry_poc ref_srv on ref_srv.cd_subctgry_poc_frc=pbcs3.cd_service_type
            join ref_service_cd_budget_poc_frc ref_bud on ref_bud.cd_budget_poc_frc=pbcs3.cd_budget_type
            where  pbcs3.start_date 
            between p_mindate and p_maxdate
            order by pbcs3.qry_type 
                , pbcs3.date_type
                , pbcs3.start_date  
                , pbcs3.cd_sib_age_grp 
                , pbcs3.cd_race_census 
                , pbcs3.cd_office_collapse 
                  , pbcs3.bin_ihs_svc_cd
                , pbcs3.cd_reporter_type
                , pbcs3.cd_access_type
                , pbcs3.cd_allegation
                , pbcs3.cd_finding
                , pbcs3.cd_service_type 
                , pbcs3.cd_budget_type 
                , pbcs3.month ;               
    end if; -- not all zero
  end if;-- flg_procedure_off =0
END
